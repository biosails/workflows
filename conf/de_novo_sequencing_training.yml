---
global:
    - indir: "data/raw"
    - outdir: "data/analysis"
    - root: "data/raw"
    - root_dir: "data/raw"
    - root_analysis_dir: "data/analysis"
    - analysis: "data/analysis/{$sample}"
    - analysis_dir: "data/analysis/{$sample}"
    - spades_dir: "data/analysis/{$sample}/spades"
    - abyss: "data/analysis/{$sample}/abyss_pe"
    - abyss_dir: "data/analysis/{$sample}/abyss_pe"
    - gapcloser_spades_dir: "data/analysis/{$sample}/gapcloser_spades"
    - gapcloser_abyss_dir: "data/analysis/{$sample}/gapcloser_spades"
    - READ1: "{$self->root_dir}/{$sample}_read1.fastq.gz"
    - READ2: "{$self->root_dir}/{$sample}_read2.fastq.gz"
    - TR1: "{$self->trimmomatic_dir}/{$sample}_read1_trimmomatic"
    - TR2: "{$self->trimmomatic_dir}/{$sample}_read2_trimmomatic"
    - kmer1: 45
    - kmer2: 50
    - kmer1_a: "{$self->abyss_dir}/Abyss_k{$self->kmer1}/Abyss.assembly-k{$self->kmer1}-scaffolds.fa"
    - kmer2_a: "{$self->abyss_dir}/Abyss_k{$self->kmer2}/Abyss.assembly-k{$self->kmer2}-scaffolds.fa"
    - file_rule: (Sample_.*)$
    - by_sample_outdir: 1
    - find_by_dir: 1
    - wait: 0
rules:
    - abyss_pe:
        local:
                - indir: "{$self->root}"
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=abyss_pe
                        #HPC module=gencore gencore_dev gencore_de_novo_genomic
                        #HPC mem=45000
                        #HPC walltime=00:45:00
                        #HPC commands_per_node=1
                        #HPC cpus_per_task=8
                        #HPC ntasks=1
                        #HPC ntasks_per_node=1
                        #
        process: |
              #TASK tags={$sample}_{$self->kmer1}
              unset PBS_NODEFILE && \
              mkdir -p {$self->outdir}/Abyss_k{$self->kmer1} && \
              abyss-pe -j 8 \
                 lib='pe1' \
                 k={$self->kmer1} \
                 name=Abyss.assembly-k{$self->kmer1} \
                 pe1='{$self->indir}/{$sample}_trimmed_R1_PE.fastq.gz {$self->indir}/{$sample}_trimmed_R2_PE.fastq.gz' \
                 se='{$self->indir}/{$sample}_trimmed_R1_SE.fastq.gz {$self->indir}/{$sample}_trimmed_R2_SE.fastq.gz' \
                 --directory={$self->outdir}/Abyss_k{$self->kmer1}

              #TASK tags={$sample}_{$self->kmer2}
              unset PBS_NODEFILE && \
              mkdir -p {$self->outdir}/Abyss_k{$self->kmer2} && \
              abyss-pe -j 8 \
                 lib='pe1' \
                 k={$self->kmer1} \
                 name=Abyss.assembly-k{$self->kmer2} \
                 pe1='{$self->indir}/{$sample}_trimmed_R1_PE.fastq.gz {$self->indir}/{$sample}_trimmed_R2_PE.fastq.gz' \
                 se='{$self->indir}/{$sample}_trimmed_R1_SE.fastq.gz {$self->indir}/{$sample}_trimmed_R2_SE.fastq.gz' \
                 --directory={$self->outdir}/Abyss_k{$self->kmer2}
    # - spades:
    #     local:
    #             - indir: "{$self->root}"
    #             - outdir: "{$self->spades_dir}"
    #             - before_meta: |
    #                     HPC DIRECTIVES
    #                     #
    #                     #HPC jobname=spades
    #                     #HPC module=gencore gencore_dev gencore_de_novo_genomic
    #                     #HPC mem=45000
    #                     #HPC walltime=06:00:00
    #                     #HPC cpus_per_task=14
    #                     #HPC commands_per_node=1
    #                     #
    #     process: |
    #        spades.py \
    #         -t 14 -m 50 \
    #         --careful \
    #         -o  {$self->spades_dir} \
    #         -1 {$self->indir}/{$sample}_trimmed_R1_PE.fastq.gz \
    #         -2 {$self->indir}/{$sample}_trimmed_R2_PE.fastq.gz \
    #         -s {$self->indir}/{$sample}_trimmed_R1_SE.fastq.gz \
    #         -s {$self->indir}/{$sample}_trimmed_R2_SE.fastq.gz
    - gapcloser_spades:
        local:
                - indir: "{$self->root}"
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=gapcloser_spades
                        ##HPC deps=spades
                        #HPC module=gencore gencore_dev gencore_de_novo_genomic
                        #HPC mem=45000
                        #HPC walltime=00:20:00
                        #HPC cpus_per_task=14
                        #HPC commands_per_node=1
                        #
        process: |
            GapCloser \
              -t 14 \
              -l 155 \
              -a {$self->spades_dir}/scaffolds.fasta \
              -b {$self->root_analysis_dir}/gapclose.config \
              -o {$self->outdir}/gapclosed_spades.fasta
    - gapcloser_abyss:
        local:
                - indir: "{$self->root}"
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=gapcloser_abyss
                        #HPC deps=abyss_pe
                        #HPC module=gencore gencore_dev gencore_de_novo_genomic
                        #HPC mem=45000
                        #HPC walltime=00:20:00
                        #HPC cpus_per_task=14
                        #HPC commands_per_node=1
                        #
        process: |
              #TASK tags={$sample}_{$self->kmer1}
              mkdir -p {$self->outdir}/Abyss_k{$self->kmer1} && \
              GapCloser \
                -t 14 \
                -l 155 \
                -a {$self->kmer1_a} \
                -b {$self->root_analysis_dir}/gapclose.config \
                -o {$self->outdir}/Abyss_k{$self->kmer1}/gapclosed_abyss{$self->kmer1}.fasta

              #TASK tags={$sample}_{$self->kmer2}
              mkdir -p {$self->outdir}/Abyss_k{$self->kmer2} && \
              GapCloser \
                -t 14 \
                -l 155 \
                -a {$self->kmer2_a} \
                -b {$self->root_analysis_dir}/gapclose.config \
                -o {$self->outdir}/Abyss_k{$self->kmer2}/gapclosed_abyss{$self->kmer2}.fasta
    - quast:
        local:
                - indir: "{$self->root}"
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=quast
                        #HPC deps=gapcloser_spades,gapcloser_abyss
                        #HPC module=gencore gencore_dev gencore_de_novo_genomic
                        #HPC mem=45000
                        #HPC walltime=00:20:00
                        #HPC cpus_per_task=8
                        #HPC commands_per_node=1
                        #
        process: |
          #TASK tags=$sample
          quast -t 8 \
              -o {$self->outdir} \
              -l SPADES,AbySS{$self->kmer1},AbySS{$self->kmer2} \
              -s {$self->spades_dir}/scaffolds.fasta {$self->kmer1_a} {$self->kmer2_a} \
              -f \
                -1 {$self->root_dir}/{$sample}/{$sample}_trimmed_R1_PE.fastq.gz \
                -2 {$self->root_dir}/{$sample}/{$sample}_trimmed_R2_PE.fastq.gz
