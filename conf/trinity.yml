---
global:
    - project: "frog_15_83"
    - outdir: "trinity/data/analysis"
    - analysis_dir: "trinity/data/analysis"
    - trimmomatic_dir: "{$sample}/{$sample}_TRIMMOMATIC"
    - trimmomatic: "{$sample}/{$sample}_TRIMMOMATIC"
    - trinity_dir: "trinity/data/analysis/trinity"
    - rsem_dir: "trinity/data/analysis/{$sample}/rsem"
    - trinity_reference: "{$self->trinity_dir}/Trinity.fasta"
    - file_rule: (Sample_RNA-B1.*)$
    - by_sample_outdir: 1
    - find_by_dir: 1
    - wait: 0
rules:
    - stash_reads:
        local:
          - override_process: 1
        process: |

                {
                  #FYI - this is custom code, and will have to be changed based on the pattern of the trimmed reads

                  use Cwd;
                  my $cwd = getcwd();
                  #Left reads
                  $self->stash->{left} = [ map { $cwd."/".$_."/$_"."_TRIMMOMATIC/".$_."_read1_trimmomatic_1PE.fastq.gz" } @{$self->samples} ];

                  #right reads
                  $self->stash->{right} = [ map { $cwd."/".$_."/$_"."_TRIMMOMATIC/".$_."_read2_trimmomatic_2PE.fastq.gz" } @{$self->samples} ];

                  #single reads
                  $self->stash->{single} = [ map {
                  $cwd."/".$_."/".$_."_TRIMMOMATIC/".$_."_read1_trimmomatic_1SE.fastq.gz,"
                  ."\\\n"
                  .$cwd."/".$_."/".$_."_TRIMMOMATIC/".$_."_read2_trimmomatic_2SE.fastq.gz"
                  }
                  @{$self->samples} ];
                  ($SILENTLY);
                }
    - trinity:
        local:
                - indir: "{$self->analysis_dir}"
                - outdir: "{$self->trinity_dir}"
                - override_process: 1
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=trinity
                        #HPC module=gencore gencore_dev gencore_trinity/1.0
                        #HPC mem=900GB
                        #HPC walltime=24:00:00
                        #HPC cpus_per_task=42
                        #HPC commands_per_node=1
                        #
        process: |
                mkdir -p {$self->trinity_dir} && \
                Trinity --verbose \
                --bypass_java_version_check --seqType fq \
                --max_memory 900G \
                --CPU 42 \
                --left { "\\\n".join(",\\\n", @{$self->stash->{left}}) } \
                --right { "\\\n".join(",\\\n", @{$self->stash->{right}}) } \
                --single { "\\\n".join(",\\\n", @{$self->stash->{single}}) } \
                --output \
                {$self->trinity_dir}
    - assembly_stats:
        local:
                - indir: "{$self->analysis_dir}"
                - outdir: "{$self->trinity_dir}"
                - override_process: 1
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=assembly_stats
                        #HPC deps=trinity
                        #HPC module=gencore gencore_dev gencore_trinity/1.0
                        #HPC mem=100GB
                        #HPC walltime=24:00:00
                        #HPC cpus_per_task=1
                        #HPC partition=serial
                        #HPC commands_per_node=1
                        #
        process: |
                TrinityStats.pl \
                {$self->trinity_dir}/Trinity.fasta > {$self->trinity_dir}/TrinityStats-{$self->project}.txt
    - bowtie_build_s:
        local:
                - indir: "{$self->trinity_dir}"
                - outdir: "{$self->trinity_dir}"
                - override_process: 1
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=bowtie_build_s
                        #HPC deps=trinity
                        #HPC module=gencore gencore_dev gencore_trinity/1.0
                        #HPC mem=10GB
                        #HPC walltime=24:00:00
                        #HPC cpus_per_task=1
                        #HPC partition=serial
                        #HPC commands_per_node=1
                        #
        process: |
                cd {$self->trinity_dir} && \
                bowtie2-build-s {$self->trinity_reference} Trinity
    - estimate_abundance:
        local:
                - indir: "{$self->trimmomatic}"
                - outdir: "{$self->trinity_dir}"
                - before_meta: |
                        HPC DIRECTIVES
                        #
                        #HPC jobname=estimate_abundance
                        #HPC deps=bowtie_build_s
                        #HPC module=gencore gencore_dev gencore_trinity/1.0
                        #HPC mem=100GB
                        #HPC walltime=24:00:00
                        #HPC cpus_per_task=1
                        #HPC partition=serial
                        #HPC commands_per_node=1
                        #
        process: |
                #TASK tags={$sample}
                align_and_estimate_abundance.pl \
                  --thread_count 72 \
                  --seqType fq \
                  --left \
                  {$self->trimmomatic_dir}/{$sample}_read_1_trimmomatic_1PE.fastq.gz \
                  --right \
                  {$self->trimmomatic_dir}/{$sample}_read_2_trimmomatic_2PE.fastq.gz \
                  --single \
                  {$self->trimmomatic_dir}/{$sample}_read_1_trimmomatic_1SE.fastq.gz,\
                  {$self->trimmomatic_dir}/{$sample}_read_1_trimmomatic_2SE.fastq.gz \
                  --transcripts {$self->trinity_reference} \
                  --output_prefix {$sample}-{$self->project} \
                  --est_method RSEM \
                  --aln_method bowtie2 \
                  --trinity_mode --output_dir {$self->rsem_dir}
